{% extends 'base.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('styles/responsable.css') }}">
    <link rel="stylesheet" href="{{ asset('styles/navbarTel.css') }}">
{% endblock %}

{% block body %}
<div class="mobile-container">
    <div class="header-section">
        <h1>üìä Rapport {{ pole.nomPole }}</h1>
        <p class="subtitle">Mise √† jour en direct</p>
    </div>

    {% if monFormulaire %}
        {{ form_start(monFormulaire, {'attr': {'id': 'form-auto-save'}}) }}
            
            {{ form_row(monFormulaire._token) }}

            {# --- SECTION 1 : SLIDERS (Tracts / Affluence) --- #}
            <div class="card-section">
                <h2>Activit√© Terrain</h2>
                
                {# TRACTS #}
                <div class="input-group-range">
                    <div class="range-header">
                        <label>Nombre de tracts</label>
                        <span class="range-value" id="val-tract">0</span>
                    </div>
                    {{ form_widget(monFormulaire.tract, {'attr': {'class': 'pretty-slider', 'oninput': 'updateSliderValue("val-tract", this.value)'}}) }}
                </div>

                {# AFFLUENCE #}
                <div class="input-group-range">
                    <div class="range-header">
                        <label>Affluence</label>
                        <span class="range-value" id="val-afluence">0</span>
                    </div>
                    {{ form_widget(monFormulaire.afluence, {'attr': {'class': 'pretty-slider', 'oninput': 'updateSliderValue("val-afluence", this.value)'}}) }}
                </div>
            </div>

            {# --- SECTION 2 : SCORES (Steppers +/-) --- #}
            <div class="card-section">
                <h2>R√©sultats Syndicats</h2>
                <div class="scores-grid">
                    {% for field in [monFormulaire.unef, monFormulaire.ue, monFormulaire.uni] %}
                        <div class="score-item">
                            {{ form_label(field) }}
                            <div class="stepper">
                                <button type="button" class="btn-stepper minus" onclick="updateStepper(this, -1)">‚àí</button>
                                {{ form_widget(field, {'attr': {'class': 'score-input', 'readonly': 'readonly'}}) }}
                                <button type="button" class="btn-stepper plus" onclick="updateStepper(this, 1)">+</button>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div id="save-status" class="save-badge hidden">
                <span class="spinner">‚è≥</span> Sauvegarde...
            </div>

        {{ form_end(monFormulaire, {'render_rest': false}) }}
    {% endif %}
</div>

{% include 'partials/_menuTel.html.twig' %}

{# --- SCRIPT OPTIMIS√â (Turbo + Debounce) --- #}
<script>
    // 1. D√âFINITION DES FONCTIONS GLOBALES (Pour les onclick HTML)
    // On les met sur 'window' pour √™tre s√ªr qu'elles soient accessibles partout
    window.updateSliderValue = function(spanId, value) {
        const el = document.getElementById(spanId);
        if(el) el.innerText = value;
    };

    window.updateStepper = function(btn, change) {
        const container = btn.parentElement;
        const input = container.querySelector('input');
        let val = parseInt(input.value) || 0;
        let newVal = val + change;
        if(newVal < 0) newVal = 0;
        
        input.value = newVal;
        // D√©clenche l'auto-save
        input.dispatchEvent(new Event('change', { bubbles: true }));
    };

    // 2. FONCTION D'INITIALISATION PRINCIPALE
    function initResponsablePage() {
        const form = document.getElementById('form-auto-save');
        if (!form) return; // S√©curit√© : on arr√™te si on n'est pas sur la bonne page

        const statusBadge = document.getElementById('save-status');
        let debounceTimer; // Le minuteur pour l'anti-spam

        // A. Initialiser les valeurs visuelles des sliders
        const tractInput = document.getElementById('mon_pole_tract');
        const affluenceInput = document.getElementById('mon_pole_afluence');
        if(tractInput) window.updateSliderValue('val-tract', tractInput.value);
        if(affluenceInput) window.updateSliderValue('val-afluence', affluenceInput.value);

        // B. √âcouteur global avec DEBOUNCE (Temporisation)
        form.addEventListener('change', function() {
            // 1. Feedback imm√©diat pour l'utilisateur
            if(statusBadge) statusBadge.classList.remove('hidden');

            // 2. On annule l'envoi pr√©c√©dent s'il y en a un en attente
            clearTimeout(debounceTimer);

            // 3. On attend 500ms avant d'envoyer vraiment
            debounceTimer = setTimeout(() => {
                saveData();
            }, 500);
        });
        
        // C. La fonction d'envoi r√©elle
        function saveData() {
            const formData = new FormData(form);
            fetch(form.action, {
                method: form.method,
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => {
                if (response.ok) {
                    console.log("‚úÖ Sauvegard√©");
                    // On laisse le badge vert un instant puis on cache
                    setTimeout(() => {
                        if(statusBadge) statusBadge.classList.add('hidden');
                    }, 800);
                } else {
                    console.error("‚ùå Erreur serveur");
                    if(statusBadge) statusBadge.innerText = "Erreur !";
                }
            })
            .catch(err => console.error(err));
        }
    }

    // 3. CHARGEMENT DU SCRIPT (Compatible Navigation Turbo + Rechargement)
    document.addEventListener('turbo:load', initResponsablePage);
    document.addEventListener('DOMContentLoaded', initResponsablePage);
</script>
{% endblock %}