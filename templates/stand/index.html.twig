{% extends 'base.html.twig' %}

{% block title %}Gestion Stock{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('styles/stock.css') }}">
    <link rel="stylesheet" href="{{ asset('styles/navbarTel.css') }}">
{% endblock %}

{% block body %}
<div class="mobile-container">
    
    <div class="header-section">
        <h1>ü•û Stocks Stand</h1>
        <p class="subtitle">Disponibilit√© des ingr√©dients</p>
    </div>

    {% if form %}
        {{ form_start(form, {'attr': {'id': 'form-auto-save'}}) }}
            {{ form_row(form._token) }}

            <div class="card-section">
                <h2>Ingr√©dients</h2>
                
                <div class="scores-grid">
                    {# On boucle sur les champs bool√©ens #}
                    {% for field in [form.lait, form.oeuf, form.rhum, form.farine] %}
                        
                        <div class="score-item">
                            {# Le label (ex: Lait en stock) #}
                            {{ form_label(field) }}
                            
                            {# L'interrupteur SWITCH #}
                            <label class="switch">
                                {# La checkbox cach√©e #}
                                {{ form_widget(field) }}
                                {# Le curseur visuel #}
                                <span class="slider round"></span>
                            </label>
                        </div>

                    {% endfor %}
                </div>
            </div>

            <div id="save-status" class="save-badge hidden">
                <span class="spinner">‚è≥</span> Sauvegarde...
            </div>

        {{ form_end(form, {'render_rest': false}) }}
    {% endif %}

</div>

{% include 'partials/_menuTel.html.twig' %}

{# --- SCRIPT OPTIMIS√â (Turbo + Debounce + Couleurs) --- #}
<script>
    function initStockPage() {
        const form = document.getElementById('form-auto-save');
        // Si le formulaire n'est pas sur cette page, on arr√™te tout (√©vite les erreurs)
        if (!form) return; 

        // On cible sp√©cifiquement les checkbox dans les switchs
        const checkboxes = document.querySelectorAll('.switch input[type="checkbox"]');
        const statusBadge = document.getElementById('save-status');
        let debounceTimer; // Le minuteur pour l'anti-spam

        // 1. Fonction VISUELLE : Rouge / Vert
        function updateStockColor(checkbox) {
            const row = checkbox.closest('.score-item');
            if (checkbox.checked) {
                row.classList.add('stock-ok');
                row.classList.remove('stock-ko');
            } else {
                row.classList.add('stock-ko');
                row.classList.remove('stock-ok');
            }
        }

        // 2. Fonction TECHNIQUE : Envoi AJAX avec DEBOUNCE
        function saveData() {
            // A. Feedback imm√©diat
            if(statusBadge) statusBadge.classList.remove('hidden');

            // B. On annule l'envoi pr√©c√©dent s'il √©tait en attente
            clearTimeout(debounceTimer);

            // C. On attend 500ms avant d'envoyer vraiment
            debounceTimer = setTimeout(() => {
                const formData = new FormData(form);

                fetch(form.action, {
                    method: form.method,
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        console.log("‚úÖ Sauvegarde r√©ussie");
                        // On cache le badge apr√®s un petit d√©lai
                        setTimeout(() => {
                            if(statusBadge) statusBadge.classList.add('hidden');
                        }, 800);
                    } else {
                        console.error("‚ùå Erreur serveur");
                        if(statusBadge) statusBadge.innerText = "Erreur !";
                    }
                })
                .catch(error => {
                    console.error("‚ùå Erreur r√©seau", error);
                });
            }, 500); // 500ms de d√©lai
        }

        // 3. Initialisation et √âcouteurs
        checkboxes.forEach(checkbox => {
            // A. On met la bonne couleur au chargement de la page
            updateStockColor(checkbox);

            // B. Quand on clique sur un switch
            checkbox.addEventListener('change', function() {
                // 1. On change la couleur imm√©diatement (super r√©actif)
                updateStockColor(this);
                // 2. On lance la sauvegarde (temporis√©e)
                saveData();
            });
        });
    }

    // Lancement compatible Navigation Turbo + Rechargement classique
    document.addEventListener('turbo:load', initStockPage);
    document.addEventListener('DOMContentLoaded', initStockPage);
</script>
{% endblock %}

{% block javascripts %}
    {{ parent() }}    
{% endblock %}